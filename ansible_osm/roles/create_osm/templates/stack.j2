heat_template_version: 2017-02-24

description: Template to deploy osm

parameters:
  image_osm:
    type: string
    description: Name of image osm
    default: osm

  flavor_osm:
    type: string
    description: Flavor for osm
    default: osm

  public_key_osm:
    type: string
    description: Public key to access osm VM
    default: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCnybji2cFSYjLel1gkFP9hjetGcnageyUUcm7+PioSgdvZy0XprEom1p/q8uimxyEmDVFQPGnpJL008/mAz1yMeK8UHhOWqgH2JZZSJV/VKh+70iBO/Q6b7LKK84QwpeJ3vA6IVkxJwTHFVnHDTpYlR9FeoY7ZR9dLm9Xxu8/1rVvDwNAkx/AWIBKMXyrwSUnIiYggjfzTKqwv/VUtTY1MnFvTfq9bCFR8dxNKGe8a/0q7sMoXaCmV4mDGi3f960ErrR5rmNpVfAXYRdIvaHeK3jVrv/6fteNwOizC4f1Pg+uo+5lWR5JhyjJTIweq+brXnhgaey0ws+dPHwR0PGIl Generated by Nova

  public_net:
    type: string
    description: External network public name
    default: new_exct

  osm_floating_ip:
    type: string
    description: Foating IP address for external access to osm (10.255.73.105)
    default: aa30a11f-ac53-49fe-884d-961600803e29

  net_osm_prefix:
    type: string
    description: Management network address
    default: 192.168.252.0/24

  router_osm_ip:
    type: string
    description: IP address to connect router to osm network
    default: 192.168.252.1


resources:
#OSM:

  router_osm:
    type: OS::Neutron::Router
    properties:
      name: router_osm
      external_gateway_info: { network:  { get_param: public_net }}

  net_osm:
    type: OS::Neutron::Net
    properties:
      name: net_osm

  subnet_osm:
    type: OS::Neutron::Subnet
    properties:
      name: subnet_osm
      network: { get_resource: net_osm }
      cidr: { get_param: net_osm_prefix }

  router_osm_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: net_osm }
      fixed_ips:
        - ip_address: { get_param: router_osm_ip }

  interf-apps-router:
    type: OS::Neutron::RouterInterface
    properties:
      router: { get_resource: router_osm }
      port: { get_resource: router_osm_port }


  key_osm:
    type: OS::Nova::KeyPair
    properties:
      name: key_osm
      public_key: { get_param: public_key_osm }

  OSM:
    type: OS::Nova::Server
    properties:
      name: OSM
      image: { get_param: image_osm }
      flavor: { get_param: flavor_osm }
      key_name: { get_resource: key_osm }
      networks:
        - port: { get_resource: OSM_mgmt_port }
      user_data: { get_file: /tmp/osm_config.yaml}
      user_data_format: RAW

  OSM_mgmt_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: net_osm }

  OSM_mgmt_floating_ip:
    type: OS::Neutron::FloatingIPAssociation
    properties:
      floatingip_id: { get_param: osm_floating_ip }
      port_id: { get_resource: OSM_mgmt_port }
    depends_on: interf-apps-router